name: Compilar Projeto SA-MP (Automático)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout do repositório
    - name: Checkout do repositório
      uses: actions/checkout@v3

    # 2️⃣ Instalar dependências básicas
    - name: Instalar dependências
      run: |
        sudo apt update
        sudo apt install -y unzip curl

    # 3️⃣ Instalar sampctl (Pawn + build tool)
    - name: Instalar sampctl
      run: |
        curl -sL https://get.sampctl.com | bash
        echo "$HOME/.sampctl/bin" >> $GITHUB_PATH

    # 4️⃣ Criar pastas de saída
    - name: Criar pastas de build
      run: |
        mkdir -p build/filterscripts
        mkdir -p build/gamemodes

    # 5️⃣ Compilar filterscripts automaticamente
    - name: Compilar todos os filterscripts
      run: |
        for file in filterscripts/**/*.pwn filterscripts/*.pwn; do
          if [ -f "$file" ]; then
            base=$(basename "$file" .pwn)
            echo "Compilando $file..."
            sampctl package build -s "$file" -i qawno/include/YSI_Storage -o build/filterscripts/"$base".amx
          fi
        done

    # 6️⃣ Compilar gamemodes automaticamente
    - name: Compilar todos os gamemodes
      run: |
        for file in gamemodes/**/*.pwn gamemodes/*.pwn; do
          if [ -f "$file" ]; then
            base=$(basename "$file" .pwn)
            echo "Compilando $file..."
            sampctl package build -s "$file" -i qawno/include/YSI_Storage -o build/gamemodes/"$base".amx
          fi
        done

    # 7️⃣ Salvar artefatos compilados
    - name: Salvar artefatos
      uses: actions/upload-artifact@v4
      with:
        name: amx-compilados
        path: |
          build/filterscripts/
          build/gamemodes/
